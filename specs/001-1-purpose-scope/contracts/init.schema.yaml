# Contract: Initialize Vault
# Command: will-encrypt init

command: init

description: |
  Initialize a new threshold cryptography vault with K-of-N secret sharing.
  Generates hybrid RSA-4096 + Kyber-1024 keypair, creates N BIP39 mnemonic shares,
  and produces vault.yaml file with all artifacts except shares (displayed to terminal only).

arguments:
  - name: --k
    type: integer
    required: true
    validation:
      - min: 1
      - max: 255
    description: Number of shares required to decrypt (threshold)
    example: "--k 3"

  - name: --n
    type: integer
    required: true
    validation:
      - min: 1
      - max: 255
      - constraint: "n >= k"
    description: Total number of shares to generate
    example: "--n 5"

  - name: --vault
    type: path
    required: false
    default: "./vault.yaml"
    validation:
      - must_not_exist: true
      - writable_directory: true
    description: Path to vault file (will be created)
    example: "--vault /path/to/vault.yaml"

  - name: --force
    type: boolean
    required: false
    default: false
    description: Overwrite existing vault file if present (DANGEROUS)
    example: "--force"

outputs:
  terminal_display:
    - bip39_mnemonics:
        count: N
        format: "24 words per share, numbered 1 to N"
        warning: "NEVER SHARE THIS SCREEN. COPY EACH MNEMONIC SEPARATELY."
    - instructions:
        message: "Distribute one mnemonic to each of N key holders. Store securely (paper, password manager, HSM)."

  vault_file:
    path: "Value of --vault argument"
    format: "YAML"
    permissions: "0600 (owner read/write only)"
    contents:
      - version
      - created_timestamp
      - keys (public + encrypted private)
      - messages (empty array)
      - manifest
      - recovery_guide
      - policy_document
      - crypto_notes

exit_codes:
  0: Success
  1: Invalid arguments (k > n, k < 1, n > 255)
  2: Vault file already exists and --force not specified
  3: Cryptographic operation failed (key generation, share creation)
  4: Filesystem error (cannot write vault file, permissions)

performance:
  target_duration: "< 5 seconds"
  bottlenecks:
    - RSA-4096 key generation (~2 seconds)
    - Kyber-1024 key generation (~0.5 seconds)
    - PBKDF2 key derivation (~1 second with 600k iterations)

security_requirements:
  - Passphrase MUST be 384 bits (48 bytes) from secrets.token_bytes()
  - Shares MUST NOT be written to disk, temp files, or logs
  - Private keys MUST be encrypted before storage
  - KDF salt MUST be 32 bytes from secrets.token_bytes()

example_usage: |
  # Initialize 3-of-5 threshold vault
  will-encrypt init --k 3 --n 5 --vault /secure/vault.yaml

  # Output (terminal):
  ====================================
  THRESHOLD VAULT INITIALIZED
  ====================================

  Configuration:
  - Threshold: 3 of 5 shares required
  - Vault: /secure/vault.yaml

  SECRET SHARES (BIP39 MNEMONICS)
  ⚠️  NEVER SHARE THIS SCREEN ⚠️
  ⚠️  DISTRIBUTE SEPARATELY TO KEY HOLDERS ⚠️

  Share 1 of 5:
  abandon ability able about above absent absorb abstract absurd abuse access accident
  account accuse achieve acid acoustic acquire across act action actor actress actual

  Share 2 of 5:
  adapt add addict address adjust admit adult advance advice aerobic affair afford
  afraid after again age agent agree ahead aim air airport aisle alarm

  [... shares 3, 4, 5 ...]

  NEXT STEPS:
  1. Copy each share to secure location (paper, password manager, HSM)
  2. Distribute one share to each of 5 key holders
  3. Back up vault.yaml to ≥3 independent locations
  4. Test recovery with 3 shares to verify setup

  Vault created successfully at: /secure/vault.yaml
