# Contract: Rotate Shares or Passphrase
# Command: will-encrypt rotate

command: rotate

description: |
  Rotate secret shares (change K/N or redistribute shares) or rotate passphrase
  (re-encrypt private keys). Share rotation does NOT re-encrypt messages.
  Passphrase rotation re-encrypts private keys but NOT messages.

arguments:
  - name: --vault
    type: path
    required: false
    default: "./vault.yaml"
    validation:
      - must_exist: true
      - readable: true
      - writable: true
      - format: yaml
    description: Path to vault file
    example: "--vault /path/to/vault.yaml"

  - name: --mode
    type: enum
    required: true
    values: ["shares", "passphrase"]
    description: |
      Rotation mode:
      - shares: Generate new shares for same passphrase (optionally change K/N)
      - passphrase: Generate new passphrase and new shares, re-encrypt private keys
    example: "--mode shares"

  - name: --k
    type: integer
    required: false
    validation:
      - min: 1
      - max: 255
    description: New K value (for share or passphrase rotation). If omitted, keeps current K.
    example: "--k 4"

  - name: --n
    type: integer
    required: false
    validation:
      - min: 1
      - max: 255
      - constraint: "n >= k"
    description: New N value (for share or passphrase rotation). If omitted, keeps current N.
    example: "--n 7"

  - name: --old-shares
    type: string_array
    required: false
    validation:
      - each_element: "24 words separated by spaces"
      - bip39_checksum: true
      - count: ">= current K"
    description: Old BIP39 mnemonic shares (for authentication)
    example: '--old-shares "word1 ... word24" "word1 ... word24" "word1 ... word24"'

  - name: --interactive
    type: boolean
    required: false
    default: true
    description: Prompt for old shares interactively (secure, no shell history)
    example: "--interactive"

inputs:
  old_shares:
    source: "Interactive prompts (default) OR --old-shares argument"
    count: "Current K shares (from vault manifest)"
    purpose: "Authenticate rotation operation, reconstruct passphrase"

outputs:
  terminal_display:
    - mode: "shares | passphrase"
    - old_configuration: "Previous K/N values"
    - new_configuration: "New K/N values"
    - new_bip39_mnemonics:
        count: "New N"
        format: "24 words per share, numbered 1 to N"
        warning: "NEVER SHARE THIS SCREEN. COPY EACH MNEMONIC SEPARATELY."

  vault_file:
    modifications:
      shares_mode:
        - manifest.threshold.k: "Updated if --k provided"
        - manifest.threshold.n: "Updated if --n provided"
        - manifest.rotation_history: "Appended RotationEvent"
        - manifest.fingerprints.vault_sha256: "Updated hash"
        - keys: "NOT modified (same encrypted private keys)"
      passphrase_mode:
        - keys.encrypted_private.rsa_4096: "Re-encrypted with new passphrase"
        - keys.encrypted_private.kyber_1024: "Re-encrypted with new passphrase"
        - keys.kdf_salt: "New random salt"
        - manifest.threshold.k: "Updated if --k provided"
        - manifest.threshold.n: "Updated if --n provided"
        - manifest.rotation_history: "Appended RotationEvent"
        - manifest.fingerprints.vault_sha256: "Updated hash"

exit_codes:
  0: Success
  1: Invalid arguments (k > n, missing mode)
  2: Vault file not found or invalid format
  3: Insufficient old shares (< K provided)
  4: Invalid old share (BIP39 checksum failure)
  5: Old passphrase reconstruction failed
  6: Authentication failed (old passphrase incorrect)
  7: New share generation failed
  8: Passphrase rotation failed (re-encryption error)
  9: Vault write error

performance:
  shares_mode: "< 2 seconds (generate new shares only)"
  passphrase_mode: "< 3 seconds (re-encrypt private keys + generate shares)"

security_requirements:
  shares_mode:
    - Old passphrase MUST be reconstructed and validated
    - New shares MUST be generated from SAME passphrase
    - Private keys NOT re-encrypted (efficiency, no need)
    - Messages NOT re-encrypted (never needed for share rotation)
  passphrase_mode:
    - New passphrase MUST be 384 bits from secrets.token_bytes()
    - Old passphrase MUST be used to decrypt private keys first
    - Private keys MUST be re-encrypted with new passphrase
    - New KDF salt MUST be generated
    - Messages NOT re-encrypted (still use same keypair)
  all_modes:
    - All secrets (old/new passphrases, shares) MUST be zeroed from memory after use

example_usage: |
  # Share rotation: Change from 3-of-5 to 4-of-7 (same passphrase)
  will-encrypt rotate --vault vault.yaml --mode shares --k 4 --n 7

  Output:
  ====================================
  SHARE ROTATION
  ====================================

  Old configuration: 3 of 5 shares
  New configuration: 4 of 7 shares

  Collecting old shares for authentication...

  Enter old share 1 of 3:
  > [24 words]
  ✓ Valid

  Enter old share 2 of 3:
  > [24 words]
  ✓ Valid

  Enter old share 3 of 3:
  > [24 words]
  ✓ Valid

  Authenticating...
  Generating 7 new shares...

  NEW SECRET SHARES (BIP39 MNEMONICS)
  ⚠️  NEVER SHARE THIS SCREEN ⚠️

  Share 1 of 7:
  abandon ability able ... [24 words total]

  Share 2 of 7:
  adapt add addict ... [24 words total]

  [... shares 3-7 ...]

  NEXT STEPS:
  1. Distribute new shares to 7 key holders
  2. Destroy old shares securely (shred paper, delete from password managers)
  3. Update policy document with new holder roster

  Rotation complete. Vault updated at: vault.yaml

  # Passphrase rotation (new passphrase + new shares, re-encrypt private keys)
  will-encrypt rotate --vault vault.yaml --mode passphrase --k 3 --n 5

  Output:
  ====================================
  PASSPHRASE ROTATION
  ====================================

  Old configuration: 3 of 5 shares
  New configuration: 3 of 5 shares

  Collecting old shares...
  [Authentication flow]

  Generating new 384-bit passphrase...
  Re-encrypting private keys...
  Generating 5 new shares...

  NEW SECRET SHARES (BIP39 MNEMONICS)
  [Display new shares]

  Rotation complete. Private keys re-encrypted.
  Messages remain encrypted with original keypair (no re-encryption needed).
